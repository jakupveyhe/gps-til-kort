<!DOCTYPE html>

<html>

<head>

  <title>Her eri eg, kom og spæl.</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>

    #map { height: 350px; width: 100%; }

    #userbox, #chat { margin: 8px 0; }

    #chatlog { height: 90px; overflow-y: scroll; border: 1px solid #9ac7af; padding: 5px; background: #f0fff9;}

    #status { margin: 8px 0; font-weight: bold; }

    #chat {

      position: absolute;

      left: 0; right: 0; max-width: 400px; 

      margin: 8px auto; top: 20px; z-index: 9999;

      background: #e5f1ea; border-radius:12px; 

      padding: 6px 8px; box-shadow: 0 2px 6px #0001;

      border: 1px solid #9ac7af;

    }

    .leaflet-popup-content-wrapper {

      background: #f6fff2;

      border-radius: 8px;

      font-size: 15px;

      color: #243a1f;

    }

  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

</head>

<body>

  <h2>Kom og spæl</h2>

  <div id="userbox">

    Navn: <input id="username" placeholder="Navn:" />

    <button onclick="startTracking()">Byrja</button>

    <button id="logout" onclick="logout()" style="display:none;">Ganga út</button>

  </div>

  <div id="status"></div>

  <div id="map"></div>

  

  <!-- Chat boble over kortet -->

  <div id="chat">

    <div id="chatlog"></div>

    <input id="msg" placeholder="Skriva boð..." style="width:65%;">

    <button onclick="sendMsg()">Send</button>

  </div>



  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script>

    // Firebase-konfiguratión

    const firebaseConfig = {

      apiKey: "AIzaSyBm6TiqdDAbVwAgYKOaIaDU4uXcTk8h2XU",

      authDomain: "hererieg.firebaseapp.com",

      databaseURL: "https://hererieg-default-rtdb.europe-west1.firebasedatabase.app",

      projectId: "hererieg",

      storageBucket: "hererieg.firebasestorage.app",

      messagingSenderId: "3365578067",

      appId: "1:3365578067:web:d0c8304ee5d1ac5c1feda6",

      measurementId: "G-R9QE68V01H"

    };

    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();



    let map = L.map('map').setView([62, -6], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

      attribution: '© OpenStreetMap'

    }).addTo(map);



    let userMarker = null, otherMarkers = {}, watchId = null, currentUsername = null;

    const proximity = 20; // 20 metrar!

    const statusEl = document.getElementById('status');



    // Haversine til at máta frástøðu

    function getDistance(lat1, lng1, lat2, lng2) {

      function toRad(x) { return x * Math.PI / 180; }

      const R = 6371000;

      const dLat = toRad(lat2-lat1);

      const dLon = toRad(lng2-lng1);

      const a = Math.sin(dLat/2)*Math.sin(dLat/2) +

                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;

    }



    function startTracking() {

      const username = document.getElementById('username').value.trim();

      if (!username) {

        alert("Vinarliga skriva navn!");

        return;

      }

      currentUsername = username;

      document.getElementById('userbox').style.display = '';

      document.getElementById('logout').style.display = 'inline';

      document.getElementById('username').readOnly = true;

      document.querySelector('[onclick="startTracking()"]')?.style.setProperty('display','none');



      if ("geolocation" in navigator) {

        watchId = navigator.geolocation.watchPosition(function(pos) {

          const lat = pos.coords.latitude, lng = pos.coords.longitude;

          if (userMarker) userMarker.setLatLng([lat, lng]);

          else {

            userMarker = L.marker([lat, lng], {color: 'red'}).addTo(map)

              .bindPopup("Tú (" + username + ")").openPopup();

            map.setView([lat, lng], 15);

          }

          db.ref('positions/' + username).set({

            lat: lat,

            lng: lng,

            timestamp: Date.now()

          });

        }, function(e) {

          alert("Fek ikki staðseting: " + e.message);

        }, {enableHighAccuracy:true});

      } else {

        alert("Títt tól stuðlar ikki GPS");

      }

    }



    function logout() {

      if (currentUsername) {

        db.ref('positions/' + currentUsername).remove();

        if (watchId !== null) navigator.geolocation.clearWatch(watchId);

        alert("Tú ert farin út og tín staðseting er strikað.");

        location.reload();

      }

    }



    // VIS positionir + proximity-tjek

    db.ref('positions').on('value', function(snapshot) {

      const positions = snapshot.val();

      for (let name in otherMarkers) {

        if (!positions || !positions[name]) {

          map.removeLayer(otherMarkers[name]);

          delete otherMarkers[name];

        }

      }

      let close = false;

      if (positions) {

        const now = Date.now();

        let myPos = userMarker ? userMarker.getLatLng() : null;

        for (let name in positions) {

          const {lat, lng, timestamp} = positions[name];

          if (now - timestamp > 30000) {

            db.ref('positions/' + name).remove();

            if (otherMarkers[name]) {

              map.removeLayer(otherMarkers[name]);

              delete otherMarkers[name];

            }

            continue;

          }

          if (name === currentUsername) continue;

          // Marker for onnur

          if (!otherMarkers[name]) {

            otherMarkers[name] = L.marker([lat, lng]).addTo(map).bindPopup(name);

          } else {

            otherMarkers[name].setLatLng([lat, lng]);

          }

          // Tætheds-tjek fyri onnur

          if (myPos) {

            const dist = getDistance(myPos.lat, myPos.lng, lat, lng);

            if (dist < proximity) close = true;

          }

        }

      }

      if (close) {

        statusEl.textContent = "Tit eru nær! (minni enn 20 metrar)";

        statusEl.style.color = "green";

      } else {

        statusEl.textContent = "Tit eru ikki tætt enn ...";

        statusEl.style.color = "red";

      }

    });



    window.addEventListener('beforeunload', function() {

      if (currentUsername) db.ref('positions/' + currentUsername).remove();

    });



    // --- CHAT (ovast, sum 'boble' yvir kortinum) ---

    function sendMsg() {

      const msg = document.getElementById('msg').value.trim();

      if (!msg || !currentUsername) return;

      db.ref('chat').push({

        user: currentUsername,

        text: msg,

        ts: Date.now()

      });

      document.getElementById('msg').value = "";

    }



    db.ref('chat').limitToLast(25).on('value', function(snapshot) {

      const chatlog = document.getElementById('chatlog');

      let txt = "";

      const data = snapshot.val();

      if (data) {

        Object.values(data).forEach(msg => {

          const t = new Date(msg.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

          txt += `<b>${msg.user}</b> <span style="color:#999;">${t}</span>: ${msg.text}<br>`;

        });

      }

      chatlog.innerHTML = txt;

      chatlog.scrollTop = chatlog.scrollHeight;

    });

    document.getElementById('msg').addEventListener('keyup', function(e) {

      if (e.key === "Enter") sendMsg();

    });

  </script>

</body>

</html>