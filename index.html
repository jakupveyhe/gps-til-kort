<!DOCTYPE html>
<html>
<head>
  <title>Her eri eg, hvar ert tú?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #map { height: 400px; width: 100%; }
    #userbox { margin: 8px 0; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>
  <h2>Her eri eg</h2>
  <div id="userbox">
    Brugernavn: <input id="username" placeholder="Navn:" />
    <button onclick="startTracking()">Start</button>
    <button id="logout" onclick="logout()" style="display:none;">Log ud</button>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Firebase (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    // Din Firebase-konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyBm6TiqdDAbVwAgYKOaIaDU4uXcTk8h2XU",
      authDomain: "hererieg.firebaseapp.com",
      databaseURL: "https://hererieg-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hererieg",
      storageBucket: "hererieg.firebasestorage.app",
      messagingSenderId: "3365578067",
      appId: "1:3365578067:web:d0c8304ee5d1ac5c1feda6",
      measurementId: "G-R9QE68V01H"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map = L.map('map').setView([62, -6], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let userMarker = null;
    let otherMarkers = {};
    let watchId = null;
    let currentUsername = null;

    function startTracking() {
      const username = document.getElementById('username').value.trim();
      if (!username) {
        alert("Skriv dit navn!");
        return;
      }
      currentUsername = username;
      document.getElementById('userbox').style.display = '';
      document.getElementById('logout').style.display = 'inline';

      if ("geolocation" in navigator) {
        watchId = navigator.geolocation.watchPosition(function(pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          // Sæt/Opdater din egen markør
          if (userMarker) {
            userMarker.setLatLng([lat, lng]);
          } else {
            userMarker = L.marker([lat, lng], {color: 'red'}).addTo(map)
              .bindPopup("Du (" + username + ")").openPopup();
            map.setView([lat, lng], 15);
          }
          // Gem position til Firebase
          db.ref('positions/' + username).set({
            lat: lat,
            lng: lng,
            timestamp: Date.now()
          });
        }, function(e) {
          alert("Kan ikke hente position: " + e.message);
        }, {enableHighAccuracy:true});
      } else {
        alert("Ergtiligt/Telefonin brúkar ikki GPS");
      }
      // Vis brugernavn-feltet som readonly
      document.getElementById('username').readOnly = true;
      document.querySelector('[onclick="startTracking()"]').style.display = 'none';
    }

    function logout() {
      if (currentUsername) {
        db.ref('positions/' + currentUsername).remove();
        if (watchId !== null) navigator.geolocation.clearWatch(watchId);
        alert("Du er logget ud og din position er slettet.");
        location.reload(); // Genindlæs siden
      }
    }

    // Lyt til andres positioner og vis på kortet
    db.ref('positions').on('value', function(snapshot) {
      const positions = snapshot.val();
      // Fjern gamle markører
      for (let name in otherMarkers) {
        if (!positions || !positions[name]) {
          map.removeLayer(otherMarkers[name]);
          delete otherMarkers[name];
        }
      }
      if (positions) {
        const now = Date.now();
        for (let name in positions) {
          const {lat, lng, timestamp} = positions[name];
          // Skjul positioner ældre end 30 sekunder (auto-clean)
          if (now - timestamp > 30000) {
            // Slet fra Firebase (kan undlades hvis du kun vil skjule)
            db.ref('positions/' + name).remove();
            if (otherMarkers[name]) {
              map.removeLayer(otherMarkers[name]);
              delete otherMarkers[name];
            }
            continue;
          }
          if (name === currentUsername) continue; // undgå dobbelt
          if (!otherMarkers[name]) {
            otherMarkers[name] = L.marker([lat, lng]).addTo(map).bindPopup(name);
          } else {
            otherMarkers[name].setLatLng([lat, lng]);
          }
        }
      }
    });

    // Hvis siden lukkes, fjern brugerens position fra Firebase
    window.addEventListener('beforeunload', function() {
      if (currentUsername) db.ref('positions/' + currentUsername).remove();
    });
  </script>
</body>
</html>